/*
 * ThreadSafeWrapper_Queue.c
 *
 *  Created on: Mar 23, 2022
 *      Author: kanherea
 */
#include "FreeRTOS.h"
#include "queue.h"
#include "task.h"

#include "ThreadSafeWrapper_Queue.h"
#include "NonThreadSafeAPI.h"

static QueueHandle_t ThreadSafeQueue = NULL;
static TaskHandle_t xAgentTaskHandle = NULL;

static void vAgentTask( void * vArgs );
void ThreadSafeWrapper_QueueDeInit( void );

typedef struct xMessage
{
    UBaseType_t uxCount;
    UBaseType_t uxUseBusyWait;
    BaseType_t xUseRandomValues;
} xMessageType_t;

BaseType_t ThreadSafeWrapper_QueueInit( UBaseType_t xQueueSize,
										size_t uxAgentStackSize,
										UBaseType_t uxAgentPriority )
{
    BaseType_t xReturn = pdFAIL, xAgentTaskCreated;

	ThreadSafeQueue = xQueueCreate( xQueueSize, sizeof( xMessageType_t ) );

	if( ThreadSafeQueue != NULL )
	{
		xAgentTaskCreated = xTaskCreate( vAgentTask,
				                         "AgentTask",
										 uxAgentStackSize,
										 NULL,
										 uxAgentPriority,
										 &xAgentTaskHandle );

		if( xAgentTaskCreated != pdFAIL )
		{
			xReturn = pdPASS;
		}
	}

	return xReturn;
}

BaseType_t ThreadSafeWrapper_QueueSend( UBaseType_t uxValueToSend,
		                                UBaseType_t uxUseBusyWait,
		                                BaseType_t xUseRandomValues,
		                                TickType_t uxTimeout )
{
	BaseType_t xReturn;
	xMessageType_t xMessage;

	xMessage.uxCount = uxValueToSend;
	xMessage.uxUseBusyWait = uxUseBusyWait;
	xMessage.xUseRandomValues = xUseRandomValues;

	xReturn = xQueueSendToBack( ThreadSafeQueue, &xMessage, uxTimeout );

	return xReturn;
}

static void vAgentTask( void * vArgs )
{
	configASSERT( ThreadSafeQueue != NULL );
	xMessageType_t xMessageRecvd;

	/* Suppress compiler warnings. */
	( void ) vArgs;

	if( ThreadSafeQueue != NULL )
	{
        while( 1 )
        {
        	if( xQueueReceive( ThreadSafeQueue,
        			           ( void * ) &xMessageRecvd,
							   portMAX_DELAY ) == pdTRUE )
        	{
        		NonThreadSafeAPI( xMessageRecvd.uxCount,
        				          xMessageRecvd.uxUseBusyWait,
								  xMessageRecvd.xUseRandomValues );
        	}
        	else
        	{
        		/* With maximum delay, the queue receive should never fail. */
        		configASSERT( 0 );
        	}
        }
	}

	/* Delete the task in case the Queue is not created. */
	vTaskDelete( NULL );
}

void ThreadSafeWrapper_QueueDeInit( void )
{

}
